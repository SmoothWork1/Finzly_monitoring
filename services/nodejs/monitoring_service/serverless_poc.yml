service: monitoring-service-manager
useDotenv: true
frameworkVersion: '3'

custom:
  customDomain:
    domainName: '${env:DOMAIN_VARIABLE}'
    basePath: 'monitoring'
    stage: ${opt:stage}
    createRoute53Record: true
  logRetention:
    uat: 7
    prod: 15
    poc: 5

  STAGE: ${opt:stage}
  REGION: ${env:REGION}
  DB_TENANT: ${env:DB_TENANT}
  cognito_client: ${env:cognito_client}
  NOTIFICATION_API_URL: ${env:NOTIFICATION_API_URL}
  ACCOUNT_ID: ${aws:accountId}
  LOG_LEVEL: ${env:LOG_LEVEL}
  VPC_SECURITY_GROUP: ${env:VPC_SECURITY_GROUP}
  VPC_SUBNET: ${env:VPC_SUBNET}
  DEPLOYMENT_BUCKET: ${env:DEPLOYMENT_BUCKET}
  MONITORING_QUEUE_NAME: ${env:MONITORING_QUEUE_NAME}
  OUTLOOK_USER: ${env:OUTLOOK_USER}
  OUTLOOK_TENANTID: ${env:OUTLOOK_TENANTID}
  OUTLOOK_CLIENTID: ${env:OUTLOOK_CLIENTID}
  OUTLOOK_SECRET: ${env:OUTLOOK_SECRET}
  SCHEDULERS_FUNCTION_SEARCH_STRING: ${env:SCHEDULERS_FUNCTION_SEARCH_STRING}
  CROSSACCOUNT_ROLE: ${env:CROSSACCOUNT_ROLE}
  CROSSACCOUNT_ID: ${env:CROSSACCOUNT_ID}

  profiles:
    tooling: tooling
    dev: monitor-dev
    test: test
    uat: uat
    preprod: preprod
    prod: prod
    poc: poc
plugins:
  - serverless-latest-layer-version
  - serverless-deployment-bucket
  - serverless-domain-manager
  # - serverless-plugin-common-excludes
  #- serverless-plugin-include-dependencies
package:
  patterns:
    - '!security/**'
  excludeDevDependencies: true
provider:
  name: aws
  runtime: nodejs16.x
  region: ${self:custom.REGION}
  profile: ${self:custom.profiles.${self:custom.STAGE}}
  websocketsApiName: monitoring-service-websocket
  websocketsApiRouteSelectionExpression: $request.body.route
  websocketsDescription: Monitoring Service Websockets
  deploymentBucket:
    name: ${self:custom.DEPLOYMENT_BUCKET}
    serverSideEncryption: AES256
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource: "*"
        # - Effect: Allow
        #   Action:
        #     - sqs:SendMessage
        #     - sqs:ReceiveMessage
        #     - sqs:DeleteMessage
        #     - sqs:GetQueueUrl
        #   Resource:
        #     Fn::GetAtt:
        #       - NotificationQueue
        #       - Arn
        - Effect: Allow
          Action:
            - cognito-identity:GetId
            - cognito-identity:GetCredentialsForIdentity
          Resource: "*"
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
            - lambda:InvokeAsync
            - lambda:Invoke
            - lambda:ListFunctions
          Resource: "*"
        - Effect: Allow
          Action:
            - events:ListRules
            - events:ListRuleNamesByTarget
            - events:PutRule
          Resource: "*"
        - Effect: Allow
          Action:
            - execute-api:Invoke
          Resource: "*"
        - Effect: Allow
          Action:
            - sts:AssumeRole
          Resource: arn:aws:iam::${self:custom.CROSSACCOUNT_ID}:role/${self:custom.CROSSACCOUNT_ROLE}
        - Effect: Allow
          Action:
            - cognito-idp:SignUp
            - cognito-idp:AdminCreateUser
          Resource: "*"
  environment:
    STAGE: ${self:custom.STAGE}
    LOG_LEVEL: ${self:custom.LOG_LEVEL}
    #SQS_URL: { Ref: NotificationQueue }
    SQS_URL: ''
    cognito_client: ${self:custom.cognito_client}
    DB_TENANT: ${self:custom.DB_TENANT}
    NOTIFICATION_API_URL: ${self:custom.NOTIFICATION_API_URL}
    WEBSOCKET_URL: { Ref: WebsocketsApi }
    REGION: ${self:custom.REGION}
    OUTLOOK_USER: ${self:custom.OUTLOOK_USER}
    OUTLOOK_TENANTID: ${self:custom.OUTLOOK_TENANTID}
    OUTLOOK_CLIENTID: ${self:custom.OUTLOOK_CLIENTID}
    OUTLOOK_SECRET: ${self:custom.OUTLOOK_SECRET}
    SCHEDULERS_FUNCTION_SEARCH_STRING: ${self:custom.SCHEDULERS_FUNCTION_SEARCH_STRING}
    CROSSACCOUNT_ROLE: ${self:custom.CROSSACCOUNT_ROLE}
    CROSSACCOUNT_ID: ${self:custom.CROSSACCOUNT_ID}
functions:
  #daily-reset:
  #  handler: handlers/daily-reset.daily_reset
  #  vpc:
  #    securityGroupIds:
  #      - ${self:custom.VPC_SECURITY_GROUP}
  #    subnetIds:
  #      - ${self:custom.VPC_SUBNET}
  #  events:
  #    - schedule:
  #       name: monitoring-reset-schedule
  #       description: ""
  #       rate: cron(0 4 * * ? *)
  #       enabled: true
  #  layers:
  #    - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
  #    - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest
      
  websocket-connect:
    handler: handlers/connectWebsocket.handler
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - websocket:
          route: initiate
          routeResponseSelectionExpression: $default
          # authorizer:
          #   arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
          #   identitySource:
          #     - 'route.request.header.Auth'
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  websocket-disconnect:
    handler: handlers/disconnectWebsocket.handler
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - websocket:
          route: cease
          routeResponseSelectionExpression: $default
          # authorizer:
          #   arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
          #   identitySource:
          #     - 'route.request.header.Auth'
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  websocket-events-handler:
    handler: handlers/eventsWebsocket.handler
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - websocket:
          route: events
          routeResponseSelectionExpression: $default
          # authorizer:
          #   arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
          #   identitySource:
          #     - 'route.request.header.Auth'
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  admin-onboarding:
    handler: handlers/admin-onboarding.admin_onboarding
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    timeout: 50
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: post
          path: /register
          cors: true
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  admin-login:
    handler: handlers/admin-login.admin_login
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: post
          path: /login
          cors: true 
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-admin-cognito-info:
    handler: handlers/get-admin-cognito-info.get_admin_cognito_info
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /profile
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  # forgot-password:
  #   handler: handlers/forgot-password.forgot_password
  #   vpc:
  #     securityGroupIds:
  #       - ${self:custom.VPC_SECURITY_GROUP}
  #     subnetIds:
  #       - ${self:custom.VPC_SUBNET}
  #   events:
  #     - http:
  #         method: put
  #         path: /forgot
  #         cors: true
  #   layers:
  #     - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
  #     - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest
  
  # confirm-forgot-password:
  #   handler: handlers/confirm-forgot-password.confirm_forgot_password
  #   vpc:
  #     securityGroupIds:
  #       - ${self:custom.VPC_SECURITY_GROUP}
  #     subnetIds:
  #       - ${self:custom.VPC_SUBNET}
  #   events:
  #     - http:
  #         method: put
  #         path: /confirm_forgot
  #         cors: true
  #   layers:
  #     - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
  #     - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest

  notification-queue-monitor:
    handler: handlers/notification-queue-monitor.notification_queue_monitor
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    # events:
    #   - sqs:
    #       arn:
    #         Fn::GetAtt:
    #           - NotificationQueue
    #           - Arn
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest
  
  get-monitoring-events:
    handler: handlers/get-monitoring-events.get_monitoring_events
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /get_monitoring_events/{type}/{page}/{filter}
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-monitoring-event:	
    handler: handlers/get-monitoring-event.get_monitoring_event
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:	
      securityGroupIds:	
        - ${self:custom.VPC_SECURITY_GROUP}	
      subnetIds:	
        - ${self:custom.VPC_SUBNET}	
    events:	
      - http:	
          method: get	
          path: /get_monitoring_event/{id}	
          cors: true	
          authorizer:	
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer	
            resultTtlInSeconds: 0	
            type: request	
            identitySource: method.request.header.Authorization	
    layers:	
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  add-event-comment:	
    handler: handlers/add-event-comment.add_event_comment
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:	
      securityGroupIds:	
        - ${self:custom.VPC_SECURITY_GROUP}	
      subnetIds:	
        - ${self:custom.VPC_SUBNET}	
    events:	
      - http:	
          method: post	
          path: /add_event_comment	
          cors: true	
          authorizer:	
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer	
            resultTtlInSeconds: 0	
            type: request	
            identitySource: method.request.header.Authorization	
    layers:	
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-event-function-names:
    handler: handlers/get-event-function-names.get_event_function_names
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /get_event_function_names/{type}
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-heartbeats:
    handler: handlers/get-heartbeats.get_heartbeats
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /heartbeats
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-recent-events-by-type:
    handler: handlers/get-recent-events-by-type.get_recent_events_by_type
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /recent_event_type_count
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  update-monitoring-event:
    handler: handlers/update-monitoring-event.update_monitoring_event
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /update_monitoring_event
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  create-event-subscription:
    handler: handlers/create-event-subscription.create_event_subscription
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: post
          path: /event_subscription
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  update-event-subscriptions:
    handler: handlers/update-event-subscription.update_event_subscription
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /event_subscription
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-event-subscriptions:
    handler: handlers/get-event-subscriptions.get_event_subscriptions
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /event_subscriptions
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  delete-event-subscriptions:
    handler: handlers/delete-event-subscription.delete_event_subscription
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: delete
          path: /event_subscription/{subscriptionid}
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  flag-event:
    handler: handlers/flag-event.flag_event
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: post
          path: /flag_event
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  update-event-flag:
    handler: handlers/update-event-flag.update_event_flag
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /update_event_flag
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-flagged-events:
    handler: handlers/get-flagged-events.get_flagged_events
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /get_flagged_events
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  unflag-event:
    handler: handlers/unflag-event.unflag_event
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: delete
          path: /unflag_event/{flaggedid}
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  verify-admin:
    handler: handlers/verify-admin.verify_admin
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /verify_admin
          cors: true
    layers:
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest

  get-notifications:
    handler: handlers/get-notifications.get_notifications
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /get_notifications
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  clear-notifications:
    handler: handlers/clear-notifications.clear_notifications
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /clear_notifications
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  runtime-exceptions:
    handler: handlers/runtime-exceptions.runtime_exceptions
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    timeout: 30
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    layers:
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest
    events:
      - http:
            path: /exceptions
            method: POST
            cors:
              origin: "*"
              headers: "*"
              allowCredentials: true

  heartbeat_register:
    handler: handlers/heartbeat.heartbeat
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    timeout: 30
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    layers:
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest
    events:
      - http:
            path: /heartbeat
            method: POST
            cors:
              origin: "*"
              headers: "*"
              allowCredentials: true

  dashboard:
    handler: handlers/dashboard.dashboard
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /dashboard
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  dashboard-chart:
    handler: handlers/dashboard-chart.dashboard_chart
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /dashboard_chart/{tenant}/{type}
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  block-dashboard:
    handler: handlers/block-dashboard.block_dashboard
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /blocks
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  create-user:
    handler: handlers/create-user.create_user
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: post
          path: /users
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest
  
  update-user:
    handler: handlers/update-user.update_user
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /users
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-users:
    handler: handlers/get-users.get_users
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /users
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-managable-users:
    handler: handlers/get-managable-users.get_managable_users
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /managable_users
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest
  
  remove-user:
    handler: handlers/remove-user.remove_user
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: delete
          path: /users
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  assign-monitoring-event:
    handler: handlers/assign-monitoring-event.assign_monitoring_event
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /assign_monitoring_event
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  notification-viewed:
    handler: handlers/notification-viewed.notification_viewed
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: post
          path: /notification_viewed
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  application-health:
    handler: handlers/application-health.application_health
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    timeout: 30
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    layers:
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest
    events:
      - http:
            path: /health
            method: POST
            cors:
              origin: "*"
              headers: "*"
              allowCredentials: true

  production-issues:
    handler: handlers/production-tickets.production_tickets
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    timeout: 30
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    layers:
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest
    events:
      - http:
            path: /production_tickets
            method: POST
            cors:
              origin: "*"
              headers: "*"
              allowCredentials: true

  outlook-scanner:
    handler: handlers/outlook_listener.vendor_notifications
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    timeout: 600
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - schedule:
          name: outlook_listener-schedule
          description: ""
          rate:
            - cron(0,15,30,45 * ? * MON-FRI *) 
          enabled: true
    layers:
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest
      
  get-queries-by-lambda:
    handler: handlers/get-monitoring-agent-queries-by-lambda.get_monitoring_agent_queries_by_lambda
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    timeout: 600
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /get-monitoring-agent-queries-by-lambda/{functionName}
          cors: true
    layers:
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest

  get-queries-lambda:
    handler: handlers/get-monitoring-agents-lambda.get_monitoring_agents_lambda
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    timeout: 600
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /get-monitoring-agents-lambda
          cors: true
    layers:
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest

  get-func-by-filter:
    handler: handlers/get-function-by-filter.get_function_by_filter
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    timeout: 600
    environment:
      SCHEDULERS_FUNCTION_SEARCH_STRING: ${self:custom.SCHEDULERS_FUNCTION_SEARCH_STRING}
      CROSSACCOUNT_ROLE: ${self:custom.CROSSACCOUNT_ROLE}
      CROSSACCOUNT_ID: ${self:custom.CROSSACCOUNT_ID}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /get-function-by-filter
          cors: true
    layers:
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest

  get-func-schedules:
    handler: handlers/get-function-schedules.get_function_schedules
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    timeout: 600
    environment:
      CROSSACCOUNT_ROLE: ${self:custom.CROSSACCOUNT_ROLE}
      CROSSACCOUNT_ID: ${self:custom.CROSSACCOUNT_ID}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /get-function-schedules/{functionArn}
          cors: true

    layers:
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest

  update-func-schedule:
    handler: handlers/update-function-schedule.update_function_schedule
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    timeout: 600
    environment:
      CROSSACCOUNT_ROLE: ${self:custom.CROSSACCOUNT_ROLE}
      CROSSACCOUNT_ID: ${self:custom.CROSSACCOUNT_ID}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /update-function-schedule
          cors: true

    layers:
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:#{AWS::AccountId}:layer:monit_shared_${self:custom.STAGE}:latest

  insert-agent-query:
    handler: handlers/insert-agent-query.insert_agent_query
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: post
          path: /agent_queries
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  update-agent-query:
    handler: handlers/update-agent-query.update_agent_query
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /agent_queries
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-agent-queries:
    handler: handlers/get-agent-queries.get_agent_queries
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /agent_queries/{lambda}
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  remove-agent-query:
    handler: handlers/remove-agent-query.remove_agent_query
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: delete
          path: /agent_queries/{lambda}/{query}
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest
  
  save-devops-request:
    handler: handlers/save-devops-request.save_devops_request
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: post
          path: /requests
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  update-devops-request:
    handler: handlers/update-devops-request.update_devops_request
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /requests
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-devops-requests:
    handler: handlers/get-devops-requests.get_devops_requests
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /requests
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  remove-devops-request:
    handler: handlers/remove-devops-request.remove_devops_request
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: delete
          path: /requests/{requestid}
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  approve-devops-request:
    handler: handlers/approve-devops-request.approve_devops_request
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /requests/approve/{requestid}
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest
  
  reject-devops-request:
    handler: handlers/reject-devops-request.reject_devops_request
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /requests/reject/{requestid}
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest
  
  complete-devops-request:
    handler: handlers/complete-devops-request.complete_devops_request
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /requests/complete/{requestid}
          cors: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-events:
    handler: handlers/get-events.get_events
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /events
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  remove-event:
    handler: handlers/remove-event.remove_event
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: delete
          path: /events
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  create-event:
    handler: handlers/create-event.create_event
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: post
          path: /events
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  update-event:
    handler: handlers/update-event.update_event
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: put
          path: /events
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-uptime-apps:
    handler: handlers/get-uptime-apps.get_uptime_apps
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /uptime/apps
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-uptime-platform:
    handler: handlers/get-uptime-platform.get_uptime_platform
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /uptime/platform/{platformId}
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-uptime-allapps:
    handler: handlers/get-uptime-allapps.get_uptime_allapps
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /uptime/allapps
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-uptime-total:
    handler: handlers/get-uptime-total.get_uptime_total
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /uptime/total/{appName}/{startingDate}/{lastDate}
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-uptime-platform-today:
    handler: handlers/get-uptime-platform-today.get_uptime_platform_today
    timeout: 600
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /uptime/platformtoday/{platformId}
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-uptime-platform-specific:
    handler: handlers/get-uptime-platform-specific.get_uptime_platform_specific
    timeout: 600
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /uptime/platformspecific/{platformId}/{grp}/{resource}/{specificdate}/{textareaContent}
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:common_node_modules_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:shared_modules_${self:custom.STAGE}:latest

  get-status-by-date:
    handler: handlers/get-status-by-date.get_status_by_date
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /uptime/statusbydate/{platformId}/{grp}/{resource}/{specificdate}
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:common_node_modules_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:shared_modules_${self:custom.STAGE}:latest
      
  get-active-tenants:
    handler: handlers/get-active-tenants.get_active_tenants
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /get-active-tenants
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

  get-job-configs:
    handler: handlers/get-job-configs.get_job_configs
    logRetentionInDays: ${self:custom.logRetention.${self:custom.STAGE}}
    vpc:
      securityGroupIds:
        - ${self:custom.VPC_SECURITY_GROUP}
      subnetIds:
        - ${self:custom.VPC_SUBNET}
    events:
      - http:
          method: get
          path: /get-job-configs/{selected_stage}/{selected_tenant}
          cors:
            origin: "*"
            headers: "*"
            allowCredentials: true
          authorizer:
            arn: arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:function:monitoring-security-manager-${self:custom.STAGE}-monitoring-authorizer
            resultTtlInSeconds: 0
            type: request
            identitySource: method.request.header.Authorization
    layers:
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_common_${self:custom.STAGE}:latest
      - arn:aws:lambda:${self:custom.REGION}:${self:custom.ACCOUNT_ID}:layer:monit_shared_${self:custom.STAGE}:latest

resources:
  Resources:
    # NotificationQueue:
    #   Type: "AWS::SQS::Queue"
    #   Properties:
    #     QueueName: "monitoring_sqs_${self:custom.STAGE}"
    GatewayResponseDefault4XX:
       Type: 'AWS::ApiGateway::GatewayResponse'
       Properties:
         ResponseParameters:
           gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
           gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
         ResponseType: DEFAULT_4XX
         RestApiId:
           Ref: 'ApiGatewayRestApi'
    WebsocketsApi:
      Type: "AWS::ApiGatewayV2::Api"
      Properties:
        Name: ${self:provider.websocketsApiName}
        ProtocolType: WEBSOCKET
        RouteSelectionExpression: ${self:provider.websocketsApiRouteSelectionExpression}
        Description: ${self:provider.websocketsDescription}